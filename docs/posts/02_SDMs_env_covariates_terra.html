<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matic Jančič &amp; assist. prof. Peter Glasnović; Department of biodiversity, University of Primorska">
<meta name="dcterms.date" content="2023-10-17">
<meta name="description" content="Introduction to species distribution models, Lab 2">

<title>Matic Jančič: Teaching portfolio - OBTAINING, ASSESSING AND EXTRACTING ENVIRONMENTAL DATA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Matic Jančič: Teaching portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/maticjancic" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/maticjancic/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.researchgate.net/profile/Matic-Jancic" rel="" target="">
 <span class="menu-text"><i class="ai  ai-researchgate" title="" style="color:"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0002-6872-4078" rel="" target="">
 <span class="menu-text"><i class="ai  ai-orcid" title="" style="color:"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:maticjanchich@gmail.com" rel="" target=""><i class="bi bi-https://icons.getbootstrap.com/icons/envelope-at/" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">OBTAINING, ASSESSING AND EXTRACTING ENVIRONMENTAL DATA</h1>
                  <div>
        <div class="description">
          Introduction to species distribution models, Lab 2
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Introduction to species distribution models in R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Matic Jančič &amp; assist. prof. Peter Glasnović; Department of biodiversity, University of Primorska </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 17, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#before-we-start" id="toc-before-we-start" class="nav-link active" data-scroll-target="#before-we-start">Before we start</a></li>
  <li><a href="#lab-plan" id="toc-lab-plan" class="nav-link" data-scroll-target="#lab-plan">Lab plan</a></li>
  <li><a href="#environmental-data" id="toc-environmental-data" class="nav-link" data-scroll-target="#environmental-data">Environmental data</a>
  <ul class="collapse">
  <li><a href="#quick-look-at-the-raster-data-in-r" id="toc-quick-look-at-the-raster-data-in-r" class="nav-link" data-scroll-target="#quick-look-at-the-raster-data-in-r">Quick look at the raster data (in R)</a></li>
  <li><a href="#present-global-environmental-data" id="toc-present-global-environmental-data" class="nav-link" data-scroll-target="#present-global-environmental-data">Present global environmental data</a></li>
  <li><a href="#cropping-environmental-layers-to-extents-of-species-buffer" id="toc-cropping-environmental-layers-to-extents-of-species-buffer" class="nav-link" data-scroll-target="#cropping-environmental-layers-to-extents-of-species-buffer">Cropping environmental layers to extents of species buffer</a></li>
  </ul></li>
  <li><a href="#variable-selection-assessing-correlations-collinearity-among-environemntal-variables" id="toc-variable-selection-assessing-correlations-collinearity-among-environemntal-variables" class="nav-link" data-scroll-target="#variable-selection-assessing-correlations-collinearity-among-environemntal-variables">Variable selection: assessing correlations (collinearity) among environemntal variables</a></li>
  <li><a href="#export-the-data" id="toc-export-the-data" class="nav-link" data-scroll-target="#export-the-data">Export the data</a></li>
  <li><a href="#assignment" id="toc-assignment" class="nav-link" data-scroll-target="#assignment">Assignment</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Summary
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this lab you will:</p>
<ul>
<li>use R code to access terrestrial environmental data from <code>WorldClim</code> server and download it,</li>
<li>create a map of environmental data,</li>
<li>crop environmental data to the area of interest (buffer),</li>
<li>assess correlations between environmental data for robust variable selection (Zuur et al., 2010),</li>
<li>extract environmental data for each presence and pseudo-absence locations.</li>
</ul>
</div>
</div>
<section id="before-we-start" class="level2">
<h2 class="anchored" data-anchor-id="before-we-start">Before we start</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Open the folder <code>Introduction to species distribution models</code>,</p></li>
<li><p>Start RStudio from the <code>Rproject icon</code> named <code>Introduction to species distribution models</code>.</p></li>
<li><p>Open the R script named <code>Erebia stirius</code>.</p></li>
<li><p>When following this lab, continue to copy &amp; paste the code in the script so it is organised as it is in teaching materials.</p></li>
</ol>
</div>
</div>
</section>
<section id="lab-plan" class="level2">
<h2 class="anchored" data-anchor-id="lab-plan">Lab plan</h2>
<p><img src="05_images/Lab plan 2.jpg" class="img-fluid"></p>
<hr>
<p><img src="05_images/data _ env_space _ projection_2.png" class="img-fluid"></p>
</section>
<section id="environmental-data" class="level2">
<h2 class="anchored" data-anchor-id="environmental-data">Environmental data</h2>
<p>“For use in a distribution model, it is usual to <strong>reformat all environmental data to a raster grid</strong>. … Formatting <strong>all data to the same raster grid</strong> ensures that environmental data are available for every cell in which biological data have been recorded. These <strong>cells, containing both biological data and environmental data, are used to build the species’ distribution model</strong>”. (Pearson, 2010)</p>
<p><img src="05_images/Env_variables_table.png" class="img-fluid"></p>
<section id="quick-look-at-the-raster-data-in-r" class="level3">
<h3 class="anchored" data-anchor-id="quick-look-at-the-raster-data-in-r">Quick look at the raster data (in R)</h3>
<p>There are three possible grid types in which raster files can be defined, of which <strong>squared grid</strong> is used most often.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="05_images/grids.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Example raster grids.</figcaption>
</figure>
</div>
<p>Resolution or scale is a property of raster, that defines the size of the grid cells. At lower resolutions, cells are bigger and precision of the raster is lower. At higher resolutions the cells are smaller and the precision is higher. The choice of resolution depends on the size of the area of our research (global, regional, local), species or phenomenon in question (large scale migrations vs.&nbsp;endemic, restricted species) and <strong>availability of data</strong>. The common grid sizes available today go from 10 arc minutes (~20 km)(i.e.&nbsp;<a href="https://www.fao.org/land-water/land/land-governance/land-resources-planning-toolbox/category/details/en/c/1043064/">worldclim</a>) to 30x30 meters (<a href="https://michaelminn.net/tutorials/r-landsat/index.html">landsat</a>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="05_images/Raster resolution.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Raster resolutions.</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important consideration
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do we need to consider when we choose the grid of raster data for building species distribution models?</p>
</div>
</div>
<p>Rasters in R can be stored as:</p>
<ul>
<li>a single layer (<code class="sourceCode r">RasterLayer</code>)</li>
<li>multi-layer raster brick - can only be linked to a single (multi-layer) file (<code class="sourceCode r">RasterBrick</code>)</li>
<li>multi-layer raster stack - can be formed from separate files and/or from a few layers (‘bands’) from a single file (<code class="sourceCode r">RasterStack</code>)</li>
<li>any of the above as <code class="sourceCode r">SpatRaster</code>, “umbrella” data type in the <code class="sourceCode r">terra</code> package, which includes all the above data types from the <code class="sourceCode r">raster</code> package.</li>
</ul>
</section>
<section id="present-global-environmental-data" class="level3">
<h3 class="anchored" data-anchor-id="present-global-environmental-data">Present global environmental data</h3>
<p>For this practice we will focus only on climatic data provided by WorldClim. WorldClim is a database of high spatial resolution global weather and climate data. These data can be used for mapping and spatial modeling. The data are provided for use in research and related activities.</p>
<p><a href="http://www.worldclim.org/">WorldClim</a> - contains climatic and bioclimatic variables for:</p>
<ul>
<li><strong>present</strong> (resolution: 10 arc min; 5 min; 2.5 min; 30 arc-seconds = ~1 km)</li>
<li><strong>future</strong> - CMIP6 (we will use CMIP5) - (2050, 2070; resolution; 10 min; 5 min; 2,5 min; 30 arc-seconds = ~1 km)</li>
<li><strong>past</strong> (10 min; 5 min; 2.5 min)
<ul>
<li>Mid Holocene (6 KY);</li>
<li>LGM (22 KY);</li>
<li>Last inter-glacial (120-140 thousand years)</li>
</ul></li>
<li>it provides also the global Digital elevation model.</li>
</ul>
<p><strong>Bioclimatic variables</strong> are derived from the <strong>monthly temperature and rainfall values</strong> in order to generate more biologically meaningful variables. These are often used in species distribution modeling and related ecological modeling techniques. These bioclimatic variables represent</p>
<ul>
<li><strong>annual trends</strong> (e.g., mean annual temperature, annual precipitation),</li>
<li><strong>seasonality</strong> (e.g., annual range in temperature and precipitation) and</li>
<li><strong>extreme or limiting environmental factors</strong> (e.g., temperature of the coldest and warmest month, and precipitation of the wet and dry quarters).</li>
</ul>
<hr>
<p>The variables in worldclim dataset follow nomenclature BIO1, BIO2, …, to BIO19 and actual environmental variables behind these codes are:</p>
<ul>
<li>BIO1 = Annual Mean Temperature</li>
<li>BIO2 = Mean Diurnal Range (Mean of monthly (max temp ‐ min temp))</li>
<li>BIO3 = Isothermality (P2/P7) (* 100)</li>
<li>BIO4 = Temperature Seasonality (standard deviation *100)</li>
<li>BIO5 = Max Temperature of Warmest Month</li>
<li>BIO6 = Min Temperature of Coldest Month</li>
<li>BIO7 = Temperature Annual Range (P5‐P6)</li>
<li>BIO8 = Mean Temperature of Wettest Quarter</li>
<li>BIO9 = Mean Temperature of Driest Quarter</li>
<li>BIO10 = Mean Temperature of Warmest Quarter</li>
<li>BIO11 = Mean Temperature of Coldest Quarter</li>
<li>BIO12 = Annual Precipitation</li>
<li>BIO13 = Precipitation of Wettest Month</li>
<li>BIO14 = Precipitation of Driest Month</li>
<li>BIO15 = Precipitation Seasonality (Coefficient of Variation)</li>
<li>BIO16 = Precipitation of Wettest Quarter</li>
<li>BIO17 = Precipitation of Driest Quarter</li>
<li>BIO18 = Precipitation of Warmest Quarter</li>
<li>BIO19 = Precipitation of Coldest Quarter</li>
</ul>
<hr>
<p>We access and download global bioclimatic variables with function <code class="sourceCode r"><span class="fu">geodata</span>()</code> from <code class="sourceCode r">terra</code> package. We assign dowloaded data to <code class="sourceCode r">bioclim_data</code> object. We will download the data at spatial resolution of 2.5 degrees (~4.8 km; <code class="sourceCode r">res <span class="ot">=</span></code>). With <code class="sourceCode r">var <span class="ot">=</span> <span class="st">"bio"</span></code> we define that we want to download bioclimatic variables dataset.</p>
<p>As this dataset is roughly 650 MB big, it <strong>might take a while to download</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download Bioclim variables</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># might take some time to download!!!</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>bioclim_data <span class="ot">&lt;-</span> geodata<span class="sc">::</span><span class="fu">worldclim_global</span>(<span class="at">var =</span> <span class="st">"bio"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">res =</span> <span class="fl">2.5</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">path =</span> <span class="st">"01_data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dataset is of class <code class="sourceCode r">SpatRaster</code>, as there were 19 separate layers downloaded to your hard-drive and assigned to a single object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(bioclim_data) ; <span class="fu">names</span>(bioclim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SpatRaster"
attr(,"package")
[1] "terra"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "wc2.1_2.5m_bio_1"  "wc2.1_2.5m_bio_2"  "wc2.1_2.5m_bio_3" 
 [4] "wc2.1_2.5m_bio_4"  "wc2.1_2.5m_bio_5"  "wc2.1_2.5m_bio_6" 
 [7] "wc2.1_2.5m_bio_7"  "wc2.1_2.5m_bio_8"  "wc2.1_2.5m_bio_9" 
[10] "wc2.1_2.5m_bio_10" "wc2.1_2.5m_bio_11" "wc2.1_2.5m_bio_12"
[13] "wc2.1_2.5m_bio_13" "wc2.1_2.5m_bio_14" "wc2.1_2.5m_bio_15"
[16] "wc2.1_2.5m_bio_16" "wc2.1_2.5m_bio_17" "wc2.1_2.5m_bio_18"
[19] "wc2.1_2.5m_bio_19"</code></pre>
</div>
</div>
<p>The name of each variable starts with <code>wc2.1_2.5m_</code> and ends with <code>bio_x</code>. The first part of the name tells us about the variable itself - <code>wc2.1</code> means it come from WorldClim version 2.1 and <code>2.5m</code> tells us it is in 2.5 arc minute resolution. The last part is the variable itself, <code>bio</code> for bioclimatic variables and <code>x</code> as the consecutive number of the variable in the list, going from 1 - 19.</p>
<hr>
<p>We can simply visualise this data using the <code class="sourceCode r"><span class="fu">plot</span>()</code> function. As the <code>terra</code> package is loaded, it will know by default, that it needs to plot raster images and it will display all of the included layers (the default maximum is actually 16, so layers 17 - 19 are not displayed):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bioclim_data) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02_SDMs_env_covariates_terra_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>To visualize one layer from <code class="sourceCode r">bioclim_data</code> object we must use double square brackets <code class="sourceCode r">[[]]</code> with the number of the variable we want to extract (the variables <code class="sourceCode r">BIO1</code> to <code class="sourceCode r">BIO19</code> are arranged in increasing order from 1 - 19). If we use the number 19, we will plot the layer BIO19 = Precipitation of Coldest Quarter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bioclim_data[[<span class="dv">19</span>]]) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02_SDMs_env_covariates_terra_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Change the number 19 in <code>plot(bioclim_data[[19]])</code> and make individul plots for a couple of other bioclimatic variables. Consult the list above and try to understand how that variable is changing globally and why.</p>
</div>
</div>
</section>
<section id="cropping-environmental-layers-to-extents-of-species-buffer" class="level3">
<h3 class="anchored" data-anchor-id="cropping-environmental-layers-to-extents-of-species-buffer">Cropping environmental layers to extents of species buffer</h3>
<p>The <code>stirius_buffer</code> was created in <a href="https://maticjancic.github.io/posts/01_SDMs_species_occurence_and_absence.html#absences-and-what-to-do-if-we-dont-have-them">Lab 1</a> and saved to <code>stirius_buffer.RDS</code> <a href="https://maticjancic.github.io/posts/01_SDMs_species_occurence_and_absence.html#export-the-data">file</a> in the <code>01_data</code> folder of our project. Thus, we need to import it with <code>readRDS()</code> and reassign it to <code>stirius_buffer</code> object. As we will rely on <code>terra</code> throughout the lab, we will transform it straight away to SpatVector by <code>terra:vect()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>stirius_buffer <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">readRDS</span>(<span class="st">"01_data/stirius_buffer.RDS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cropping is a bit complicated: we need to create a mask that will contain bioclim variables cropped or extracted from the entire <code class="sourceCode r">bioclim_data</code> only for the area of <code class="sourceCode r">stirius_buffer</code>. We do this with <code class="sourceCode r"><span class="fu">mask</span>()</code> function within which we set the cropped extent with <code class="sourceCode r"><span class="fu">crop</span>()</code> function - both are from <code class="sourceCode r">raster</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>bioclim_stirius <span class="ot">&lt;-</span> <span class="fu">mask</span>(<span class="fu">crop</span>(bioclim_data,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                             stirius_buffer),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                        stirius_buffer) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Lets check what were the results of the code above, by plotting the cropped layers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bioclim_stirius)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02_SDMs_env_covariates_terra_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bioclim_stirius[[<span class="dv">19</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02_SDMs_env_covariates_terra_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section>
</section>
<section id="variable-selection-assessing-correlations-collinearity-among-environemntal-variables" class="level2">
<h2 class="anchored" data-anchor-id="variable-selection-assessing-correlations-collinearity-among-environemntal-variables">Variable selection: assessing correlations (collinearity) among environemntal variables</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What is collinearity and why should we address it?
</div>
</div>
<div class="callout-body-container callout-body">
<p>“<u>If the underlying question in a study is which covariates are driving the response variable(s)</u>, then the biggest problem to overcome is often collinearity. <strong>Collinearity is the existence of correlation between covariates</strong>. Common examples are covariates like weight and length, or water depth and distance to the shoreline. If collinearity is ignored, one is likely to end up with a confusing statistical analysis in which nothing is significant, but where dropping one covariate can make the others significant, or even change the sign of estimated parameters.” (Zuur et al., 2010)</p>
</div>
</div>
<p>Collinearity of environmental variables (correlation between pairs of variables higher than |0.7|) can be a problem when fitting models. It means that we are adding redundant information to models that can obscure the actually important variables and their effects. To address collinearity in our initial set of predictors we will use the function <code class="sourceCode r"><span class="fu">removeCollinearity</span>()</code> from the package <code class="sourceCode r">virtualspecies</code>. This function:</p>
<ul>
<li>calculates the Pearson correlation factors between all pairs of variables (<code class="sourceCode r">method <span class="ot">=</span> <span class="st">"pearson"</span></code>),</li>
<li>creates the distance matrix based on these values,</li>
<li>plots the hierarchical cluster according to distances between variables (<code class="sourceCode r">plot <span class="ot">=</span> <span class="cn">TRUE</span></code>),</li>
<li>highlights the variables that are correlated at a specified threshold (<code class="sourceCode r">multicollinearity.cutoff <span class="ot">=</span> <span class="fl">0.7</span></code>).</li>
</ul>
<p>Our remaining task is to <strong>select one variable per each block (in red rectangles below)</strong>, which will give us a subset of variables that are not strongly correlated.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important consideration
</div>
</div>
<div class="callout-body-container callout-body">
<p>This analysis provides us with statistical basis to reduce the number of variables that we will use for model building (Zuur et al., 2010; Irving et al., 2020). However, <strong>we need to use our knowledge on the ecology of our species of interest to select</strong> a final set of predictor variables that are not correlated and more importantly, <strong>that have biological/ecological meaning in explaining the distribution of selected species</strong>. We should be able to support the selection of our predictor variables with references or present good arguments for selecting each one.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"virtualspecies"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>virtualspecies<span class="sc">::</span><span class="fu">removeCollinearity</span>(bioclim_stirius, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">plot =</span> <span class="cn">TRUE</span>, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">multicollinearity.cutoff =</span> <span class="fl">0.7</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">method =</span> <span class="st">"pearson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02_SDMs_env_covariates_terra_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "wc2.1_2.5m_bio_1"  "wc2.1_2.5m_bio_5"  "wc2.1_2.5m_bio_6" 
[4] "wc2.1_2.5m_bio_9"  "wc2.1_2.5m_bio_10" "wc2.1_2.5m_bio_11"

[[2]]
[1] "wc2.1_2.5m_bio_2" "wc2.1_2.5m_bio_3"

[[3]]
[1] "wc2.1_2.5m_bio_4" "wc2.1_2.5m_bio_7"

[[4]]
[1] "wc2.1_2.5m_bio_8"

[[5]]
[1] "wc2.1_2.5m_bio_12" "wc2.1_2.5m_bio_13" "wc2.1_2.5m_bio_14"
[4] "wc2.1_2.5m_bio_16" "wc2.1_2.5m_bio_17" "wc2.1_2.5m_bio_19"

[[6]]
[1] "wc2.1_2.5m_bio_15"

[[7]]
[1] "wc2.1_2.5m_bio_18"</code></pre>
</div>
</div>
<hr>
<p><strong>Reminder:</strong></p>
<p><em>Erebia stirius</em> or Stirian ringlet: butterfly species, endemic to the area between the SE Alps and the N Dinaric Alps, where it inhabits <strong>grassy, rocky slopes</strong>, between <strong>700 and 1800 m</strong>. Caterpillars feed mainly on the grass species <em>Sesleria caerulea</em>.</p>
<hr>
<p>We note that there are three variables <em>alone</em> inside the red rectangle. These are not highly correlated to any other, and can be selected without any additional statistical consideration:</p>
<ul>
<li>BIO8 = Mean Temperature of Wettest Quarter</li>
<li>BIO15 = Precipitation Seasonality</li>
<li>BIO18 = Precipitation of Warmest Quarter</li>
</ul>
<p>Our first decision is to select only one from the first big rectangle:</p>
<ul>
<li>BIO12 = Annual Precipitation</li>
<li>BIO13 = Precipitation of Wettest Month</li>
<li>BIO14 = Precipitation of Driest Month</li>
<li>BIO16 = Precipitation of Wettest Quarter</li>
<li>BIO17 = Precipitation of Driest Quarter (<em>potentially influencing growth of grass species Sesleria caerulea?</em>)</li>
<li>BIO19 = Precipitation of Coldest Quarter</li>
</ul>
<p>and to select only one from the second big rectangle:</p>
<ul>
<li>BIO1 = Annual Mean Temperature</li>
<li>BIO5 = Max Temperature of Warmest Month</li>
<li>BIO6 = Min Temperature of Coldest Month (<em>potentially inhibiting species occupying higher altitudes?</em>)</li>
<li>BIO9 = Mean Temperature of Driest Quarter</li>
<li>BIO10 = Mean Temperature of Warmest Quarter</li>
<li>BIO11 = Mean Temperature of Coldest Quarter</li>
</ul>
<p>And lastly between two pairs:</p>
<ul>
<li>BIO2 = Mean Diurnal Range (<em>potentially influencing length of breeding season</em>)</li>
<li>BIO3 = Isothermality</li>
</ul>
<p>and</p>
<ul>
<li>BIO4 = Temperature Seasonality (<em>potentially influencing length of breeding season</em>)</li>
<li>BIO7 = Temperature Annual Range</li>
</ul>
<p>When we have this final selection, we subset (retain) only the selected variables, that we will use for modelling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bioclim_stirius <span class="ot">&lt;-</span> <span class="fu">subset</span>(bioclim_stirius, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">c</span>(<span class="st">"wc2.1_2.5m_bio_2"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_4"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_6"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_8"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_15"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_17"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"wc2.1_2.5m_bio_18"</span>))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bioclim_stirius) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "wc2.1_2.5m_bio_2"  "wc2.1_2.5m_bio_4"  "wc2.1_2.5m_bio_6" 
[4] "wc2.1_2.5m_bio_8"  "wc2.1_2.5m_bio_15" "wc2.1_2.5m_bio_17"
[7] "wc2.1_2.5m_bio_18"</code></pre>
</div>
</div>
<hr>
<p>Last step in the preparation of data is to extract the environmental values for each presence and pseudo-absence point (remember we stored them in <code class="sourceCode r">stirius_pa.RDS</code> in the <a href="https://maticjancic.github.io/posts/01_SDMs_species_occurence_and_absence.html#export-the-data">first lab</a>, with coordinates being in columns <code class="sourceCode r">lon</code> and <code class="sourceCode r">lat</code>. We extract values from raster files using <code class="sourceCode r"><span class="fu">extract</span>()</code> function. The first argument is the raster layer or layers, from which we want to extract. The second argument are the longitude and latitude coordinates of the points of interest. We will access them with <code class="sourceCode r">dplyr<span class="sc">::</span><span class="fu">select</span>()</code> from <code class="sourceCode r">stirius_pa</code>. Extracted data will be stored temporarily in a new object <code class="sourceCode r">stirius_pa_bioclim</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>stirius_pa <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"01_data/stirius_pa.RDS"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>stirius_pa_bioclim <span class="ot">&lt;-</span> <span class="fu">extract</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    bioclim_stirius,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(stirius_pa, lon, lat)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will also apply <code class="sourceCode r"><span class="fu">drop_na</span>()</code> function to the dataset, to remove all the pseudo-absence points that might have been generated <strong>on the sea, lakes or rivers</strong> (having environmental data equal to <code class="sourceCode r"><span class="cn">NA</span></code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>stirius_pa_bioclim <span class="ot">&lt;-</span> stirius_pa_bioclim <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we will merge the environmental data with our presence - pseudo-absence dataset using <code class="sourceCode r"><span class="fu">cbind</span>()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>stirius_pa <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    stirius_pa,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    stirius_pa_bioclim</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stirius_pa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          species      lat      lon presence ID wc2.1_2.5m_bio_2
1 Erebia parmenio 45.95096 11.44143        0  1         7.052333
2 Erebia parmenio 46.00191 14.06301        0  2         8.737666
3 Erebia parmenio 46.91182 12.49829        0  3         7.005333
4 Erebia parmenio 46.49978 13.67425        0  4         9.366000
5 Erebia parmenio 46.48025 12.94345        0  5         8.426000
6 Erebia parmenio 46.58441 14.02201        0  6        10.477333
  wc2.1_2.5m_bio_4 wc2.1_2.5m_bio_6 wc2.1_2.5m_bio_8 wc2.1_2.5m_bio_15
1         650.0859           -5.364        13.902666          45.91653
2         701.4801           -5.088         4.383333          20.45457
3         620.9182           -9.740         8.678666          30.58824
4         692.6573           -7.992         5.906000          24.87869
5         646.9081           -6.872        13.117333          30.09015
6         791.2856           -6.952        17.753334          30.01317
  wc2.1_2.5m_bio_17 wc2.1_2.5m_bio_18
1                65               232
2               408               495
3               212               469
4               262               478
5               200               447
6               168               374</code></pre>
</div>
</div>
<hr>
</section>
<section id="export-the-data" class="level2">
<h2 class="anchored" data-anchor-id="export-the-data">Export the data</h2>
<p>We will export the final presence - pseudo absence dataframe, which now contains also the values at each location for associated environmental variables. We will export also the cropped environmental variables (<code>bioclim_stirius</code>), so they will be available to us in the following labs, when we will need it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(stirius_pa, <span class="st">"01_data/stirius_pa_final.RDS"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(bioclim_stirius, <span class="st">"01_data/bioclim_stirius.RDS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignment" class="level2">
<h2 class="anchored" data-anchor-id="assignment">Assignment</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Open R script that you named after the species you choose to work on.</p></li>
<li><p>Copy - paste <code>today's</code> code from the <code>Erebia stirius</code> script to the end of your script.</p></li>
<li><p>Adapt the code to achieve the following:</p></li>
</ol>
<p>3.1) crop the global <code>bioclim_data</code> to the extent of your species buffer (you will need to import the buffer, if you saved it in the previous lab or rerun the code above, to create it again),</p>
<p>3.2) assess the collinearity between variables within the cropped area and select meaningful variables for further analysis,</p>
<p>3.3) extract values for each location of your presence-pseudo absence dataset (you will need to import the dataset, if you saved it in the previous lab or rerun the code above, to create it again),</p>
<p>3.4) export the final dataframe with extracted environmental data to the hard drive and also the cropped environmental variables,</p>
<p>3.5) save the script with the code for your species,</p>
<p>3.6) make sure that the project folder will be available to you next week at the labs (either store it on USB, cloud or similar, in case it gets deleted from computers).</p>
</div>
</div>
<hr>
<p><br></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>